{"version":3,"file":"perspectives-pageworker.js","sources":["../src/perspectives-pageworker.js"],"sourcesContent":["// BEGIN LICENSE\n// Perspectives Distributed Runtime\n// Copyright (C) 2019 Joop Ringelberg (joopringelberg@perspect.it), Cor Baars\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with this program.  If not, see <https://www.gnu.org/licenses/>.\n//\n// Full text of this license can be found in the LICENSE file in the projects root.\n// END LICENSE\n\n// Notice that even though the method name \"postMessage\" equals that of Window.postMessage, here we deal\n// with MessagePort.postMessage and ServiceWorker.postMessage. These methods have a different interface.\n// See:\n// https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage\n// https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker/postMessage\n// https://developer.mozilla.org/en-US/docs/Web/API/MessagePort/postMessage\n\n////////////////////////////////////////////////////////////////////////////////\n//// STORING PORTS SENT BY CLIENT PAGES\n////////////////////////////////////////////////////////////////////////////////\n// An array of MessageChannel ports.\nconst channels = {};\nlet channelIndex = 1;\n\n////////////////////////////////////////////////////////////////////////////////\n//// PORT TO PAGE THAT HOSTS PDR\n//// RECEIVE PORTS FROM CLIENTS WHEN RUN IN THE MAIN PAGE, RELAYED THROUGH A SERVICE WORKER\n//// This function is passed on by the client in the call configurePDRProxy({pageHostingPDRPort: pageHostingPDRPort})\n//// This function returns a MessagePort as documented here: https://developer.mozilla.org/en-US/docs/Web/API/MessagePort.\n////////////////////////////////////////////////////////////////////////////////\nexport default function pageHostingPDRPort(pdr) {\n  // Create a channel.\n  const channel = new MessageChannel();\n  let weHost = false;\n  let portTransferred = false;\n\n  \n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.register(\n      \"perspectives-pagedispatcher\" + __PAGEDISPATCHER_VERSION__ + \".js\",\n      {\n        scope: './'\n      }).then(function (registration) {\n\n        function sendPortToController() {\n          // Only send if we have a controller\n          if (navigator.serviceWorker.controller && !portTransferred) {\n            console.log(\"Pageworker: sending port to controller\");\n            navigator.serviceWorker.controller.postMessage({ messageType: \"relayPort\", port: channel.port2 }, [channel.port2]);\n            portTransferred = true;\n          } else {\n            console.log(\"Pageworker: no controller available yet\");\n          }\n        }\n     \n        let serviceWorker;\n        if (registration.installing) {\n          console.log(\"Pageworker: service worker is installing\");\n          serviceWorker = registration.installing;\n          serviceWorker.addEventListener('statechange', function() {\n            console.log(\"Pageworker: service worker state changed to \" + serviceWorker.state);\n            if (serviceWorker.state === 'activated') {\n              console.log(\"Pageworker: worker just activated, waiting briefly before sending message\");\n              // Small delay to ensure controller is properly set up\n              setTimeout(sendPortToController, 100);\n            }\n          });\n        } else if (registration.active) {\n          serviceWorker = registration.active;\n          console.log(\"Pageworker: worker already active\");\n          sendPortToController();\n        }\n        else if (registration.waiting) {\n          console.log(\"Pageworker: worker waiting\");\n          serviceWorker = registration.waiting;\n        }\n        if (serviceWorker) {\n          console.log(\"Pageworker: service worker found\");\n          // Listen to messages coming in from the serviceWorker. The serviceWorker is the central hub that passes messages\n          // between the page hosting the PDR and the other pages.\n          // Notice that all pages that are not the first will never handle a message.\n          // Notice that this handler is on the ServiceWorkerContainer of EACH PAGE; NOT IN THE SERVICEWORKER ITSELF!\n\n          // Notice that this listener is just used to shuffle ports between pages.\n          // We establish a connection between the page that hosts the PDR and the page that\n          // wants to use the PDR. That connection is a 'channel'.\n          // It consists of two ports. One port is sent by the page that wants to use de PDR.\n          // It is received and used by the page that hosts the PDR.\n          // The other port is used by the page that wants to use the PDR.\n          // Corrolary: this listener has nothing to do with Perspectives calls that are passed \n          // from client pages to the PDR!\n          navigator.serviceWorker.addEventListener('message', function (event) {\n            switch (event.data.messageType) {\n              case \"youHost\":\n                const hostingPage = event.data.port;\n                hostingPage.start();\n                // This message only arrives to the very first page visiting InPlace.\n                // This page must host the PDR.\n                weHost = true;\n                // We've sent ourselves a port.\n                channels[channelIndex] = hostingPage;\n                // Return the channelIndex.\n                console.log(\"Pageworker: we host the PDR. We send channelId to the page that hosts the PDR.\")\n                channels[channelIndex].postMessage({ responseType: \"WorkerResponse\", serviceWorkerMessage: \"channelId\", channelId: 1000000 * channelIndex });\n                // start listening to the new channel, handle requests.\n                // The page that has sent the port will send WorkerResponse messages and API calls\n                hostingPage.onmessage = request => pdr.handleClientRequest(pdr, channels, request, 1000000 * channelIndex);\n                // increment the index so we're ready for the next page that connects.\n                channelIndex = channelIndex + 1;\n                break;\n              case \"relayPort\":\n                // If we are the host, save the port; otherwise ignore.\n                if (weHost) {\n                  // Notice how this section is exactly the same as the one in the onconnect handler of the SharedWorker.\n                  const connectionToAPage = event.data.port;\n                  connectionToAPage.start();\n                  // the new client (page) sends a port. This is a MessagePort.\n                  channels[channelIndex] = connectionToAPage;\n                  // Return the channelIndex.\n                  console.log(\"Pageworker: we are not the host. We send channelId to the page that wants to use the PDR.\")\n                  channels[channelIndex].postMessage({ responseType: \"WorkerResponse\", serviceWorkerMessage: \"channelId\", channelId: 1000000 * channelIndex });\n                  // start listening to the new channel, handle requests.\n                  connectionToAPage.onmessage = request => pdr.handleClientRequest(pdr, channels, request, 1000000 * channelIndex);\n                  // increment the index so we're ready for the next page that connects.\n                  channelIndex = channelIndex + 1;\n                }\n                break;\n            }\n          });\n          // if (navigator.serviceWorker.controller) {\n          //   console.log(\"Pageworker: navigator heeft controler direct na registreren - deze pagina stuurt relayport nu.\")\n          //   // This call transfers port2 of the channel to the serviceWorker perspectives-pagedispatcher.js.\n          //   // The serviceWorker will transfer it to the page hosting the PDR.\n          //   // NOTICE that by providing the port as a second argument, we transfer ownership of the port to the serviceWorker.\n          //   navigator.serviceWorker.controller.postMessage({ messageType: \"relayPort\", port: channel.port2 }, [channel.port2]);\n          // }\n        }\n        else {\n          console.log(\"Could not get serviceWorker from registration for an unknown reason.\");\n        }\n        // Listen to the controllerchange event. This is fired when the service worker takes control of the page.\n        // For the first page that registers, the case above (if (navigator.serviceWorker.controller)) will be false.\n        // Hence, the first page would never send a \"relayPort\" message to the service worker.\n        // Also, when a new version of the service worker is installed, the controllerchange event is fired, too.\n        navigator.serviceWorker.addEventListener(\"controllerchange\", () => {\n          // Send the port to the serviceWorker, to relay it to the page hosting the PDR.\n          // Only the serviceworker knows how many clients it has. If there is but one, it will immediately\n          // return a \"youhost\" message to this listener, which will set 'wehost' to true. \n          // See: https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker/postMessage\n          console.log(\"Pageworker: controller change. Deze pagina heeft de PDR, of er is een nieuwe versie van 'perspectives-pagedispachter.js'. Hij stuurt relayport nu.\")\n          sendPortToController();\n          // navigator.serviceWorker.controller.postMessage({ messageType: \"relayPort\", port: channel.port2 }, [channel.port2]);\n        });\n\n      }).catch(function (error) {\n        // Something went wrong during registration. The service-worker.js file\n        // might be unavailable or contain a syntax error.\n        console.log(error);\n      });\n  }\n  else {\n    console.log(\"This browser does not support service workers.\");\n  }\n  // Use port1 in the SharedWorkerChannel.\n  return channel.port1;\n}\n"],"names":["channels","channelIndex","pageHostingPDRPort","pdr","channel","MessageChannel","weHost","portTransferred","navigator","serviceWorker","register","__PAGEDISPATCHER_VERSION__","scope","then","registration","sendPortToController","controller","console","log","postMessage","messageType","port","port2","installing","addEventListener","state","setTimeout","active","waiting","event","data","hostingPage","start","responseType","serviceWorkerMessage","channelId","onmessage","request","handleClientRequest","connectionToAPage","error","port1"],"mappings":"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"}